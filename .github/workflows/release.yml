name: Build Desktop App with Pake

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version tag (e.g., v1.0.0)"
                required: true
                default: "v1.0.0"

permissions:
    contents: write

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                include:
                    - os: ubuntu-latest
                      platform: linux
                      asset_name: Vesper-RSS
                      icon_path: ./static/icon-512.png
                    - os: macos-latest
                      platform: mac
                      asset_name: Vesper-RSS
                      icon_path: ./static/icon-512.png
                    - os: windows-latest
                      platform: windows
                      asset_name: Vesper-RSS
                      icon_path: ./static/vesper.ico

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Install system dependencies (Linux)
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

            - name: Build production bundle (desktop)
              run: npm run build
              env:
                  BUILD_TARGET: desktop
                  VITE_FEED_PROXY_BASE: "https://vesper.pages.dev"

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Clone Pake and build desktop app (Linux/Mac)
              if: matrix.os != 'windows-latest'
              run: |
                  set -e  # Exit on error
                  
                  # Clone Pake repo
                  PAKE_DIR="${{ runner.temp }}/pake-build"
                  git clone --depth 1 https://github.com/tw93/Pake.git "$PAKE_DIR"
                  cd "$PAKE_DIR"
                  pnpm install
                  pnpm run cli:build
                  
                  # Ensure dist directory exists (workaround for Pake bug)
                  mkdir -p dist
                  
                  # Copy our assets to a completely separate location outside pake dir
                  ASSETS_DIR="/tmp/vesper-web-assets"
                  mkdir -p "$ASSETS_DIR"
                  cp -r ${{ github.workspace }}/build/* "$ASSETS_DIR/"
                  cp ${{ github.workspace }}/${{ matrix.icon_path }} "$ASSETS_DIR/"
                  
                  # Run pake - point to index.html file directly
                  node dist/cli.js "$ASSETS_DIR/index.html" \
                    --name VesperRSS \
                    --icon "$ASSETS_DIR/$(basename ${{ matrix.icon_path }})" \
                    --use-local-file
                  
                  # Debug: show what Pake produced (outputs to current working directory)
                  echo "=== Pake build output (current directory) ==="
                  ls -la
                  find . -maxdepth 1 -type f \( -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" \) 2>/dev/null || echo "No app files in current dir"
                  
                  # Copy output back - Pake outputs to current working directory
                  find . -maxdepth 1 -type f -name "*.dmg" -exec cp {} ${{ github.workspace }}/VesperRSS.dmg \;
                  find . -maxdepth 1 -type f -name "*.deb" -exec cp {} ${{ github.workspace }}/vesper-rss.deb \;

            - name: Clone Pake and build desktop app (Windows)
              if: matrix.os == 'windows-latest'
              shell: pwsh
              run: |
                  $ErrorActionPreference = "Stop"
                  
                  $PAKE_DIR = "${{ runner.temp }}\pake-build"
                  git clone --depth 1 https://github.com/tw93/Pake.git $PAKE_DIR
                  cd $PAKE_DIR
                  pnpm install
                  pnpm run cli:build
                  
                  # Ensure dist directory exists
                  New-Item -ItemType Directory -Force -Path dist
                  
                  # Copy our assets to a completely separate location
                  $ASSETS_DIR = "C:\vesper-web-assets"
                  New-Item -ItemType Directory -Force -Path $ASSETS_DIR
                  Copy-Item -Recurse ${{ github.workspace }}\build\* $ASSETS_DIR\
                  Copy-Item ${{ github.workspace }}\${{ matrix.icon_path }} $ASSETS_DIR\
                  
                  $iconName = Split-Path -Leaf "${{ matrix.icon_path }}"
                  node dist\cli.js "$ASSETS_DIR\index.html" --name VesperRSS --icon "$ASSETS_DIR\$iconName" --use-local-file
                  
                  # Debug: show what Pake produced (outputs to current working directory)
                  Write-Host "=== Pake build output (current directory) ==="
                  Get-ChildItem -Filter "*.exe"
                  Get-ChildItem -Filter "*.msi"
                  
                  # Copy output - Pake outputs to current working directory
                  $exe = Get-ChildItem -Filter "*.exe" | Where-Object { $_.Name -match "VesperRSS" } | Select-Object -First 1
                  if ($exe) {
                      Copy-Item $exe.FullName -Destination "${{ github.workspace }}\VesperRSS.exe" -Force
                  }
                  $msi = Get-ChildItem -Filter "*.msi" | Select-Object -First 1
                  if ($msi) {
                      Copy-Item $msi.FullName -Destination "${{ github.workspace }}\VesperRSS.msi" -Force
                  }

            - name: List build outputs
              shell: bash
              run: |
                  ls -lah
                  find . -maxdepth 1 -type f \( -name "*.dmg" -o -name "*.deb" -o -name "VesperRSS*.exe" \) 2>/dev/null || true

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: vesper-rss-${{ matrix.platform }}
                  path: |
                      VesperRSS*.dmg
                      VesperRSS*.exe
                      VesperRSS*.msi
                      *vesper*.deb
                  if-no-files-found: warn

    release:
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./artifacts

            - name: Display structure of downloaded files
              run: ls -R ./artifacts

            - name: Organize and rename artifacts
              run: |
                  mkdir -p ./release
                  # Only copy the specific app files, not build artifacts
                  find ./artifacts -type f -name "VesperRSS*.dmg" -exec cp {} ./release/ \;
                  find ./artifacts -type f -name "VesperRSS*.exe" -exec cp {} ./release/ \;
                  find ./artifacts -type f -name "VesperRSS*.msi" -exec cp {} ./release/ \;
                  find ./artifacts -type f -name "*vesper*.deb" -exec cp {} ./release/ \;
                  ls -lah ./release

            - name: Create checksums
              run: |
                  cd ./release
                  sha256sum * > SHA256SUMS.txt
                  cat SHA256SUMS.txt

            - name: Release
              uses: softprops/action-gh-release@v2
              with:
                  files: ./release/*
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  body: |
                      ## Desktop App Downloads

                      Pre-built desktop packages for Vesper RSS Reader.

                      **Note:** Enable "Direct Fetch Mode" in Settings for desktop apps without a server proxy.

                      ### Installation
                      - **macOS**: Download `.dmg` and drag to Applications
                      - **Windows**: Download `.exe` (portable, no installation needed)
                      - **Linux**: Download `.deb` and install with `sudo dpkg -i vesper-rss*.deb`

                      ### Direct Fetch Mode

                      Desktop apps run without a server proxy. Enable **Direct Fetch Mode** in Settings:
                      - ‚úÖ Works with CORS-friendly feeds (blogs, personal sites)
                      - ‚ö†Ô∏è Some feeds may fail due to CORS (major news sites)
                      - üí° Disable Direct Fetch Mode if feeds don't load

                      ### What's New
                      See the [changelog](https://github.com/lsj5031/vesper/blob/main/CHANGELOG.md) for details.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
